---
import Layout from '../../layouts/Layout.astro'
import { getBlogPosts, urlFor, isSanityConfigured } from '../../lib/sanity'
import type { BlogPost } from '../../lib/sanity'

// Fallback posts for development / when Sanity is not configured
const fallbackPosts = [
  {
    _id: '1',
    slug: { current: 'kak-poluchit-razreshenie-na-stroitelstvo' },
    title: 'Как получить разрешение на строительство в 2026 году',
    excerpt: 'Подробный гайд по получению уведомления о начале строительства ИЖС. Какие документы нужны, куда подавать, сроки рассмотрения.',
    categories: ['docs'],
    publishedAt: '2026-01-15',
    readTime: 8
  },
  {
    _id: '2',
    slug: { current: 'vybor-materiala-sten' },
    title: 'Выбор материала стен: газобетон vs кирпич vs каркас',
    excerpt: 'Сравнение популярных материалов для строительства дома. Плюсы, минусы, стоимость, теплопроводность.',
    categories: ['construction'],
    publishedAt: '2026-01-10',
    readTime: 12
  },
  {
    _id: '3',
    slug: { current: 'planirovka-doma-oshibki' },
    title: '10 ошибок при планировке дома, которых легко избежать',
    excerpt: 'Разбираем типичные ошибки: неудобное зонирование, недостаток розеток, проблемы с инсоляцией и как их предотвратить.',
    categories: ['design'],
    publishedAt: '2026-01-05',
    readTime: 10
  },
  {
    _id: '4',
    slug: { current: 'ipoteka-na-stroitelstvo-2026' },
    title: 'Ипотека на строительство дома: условия банков в 2026',
    excerpt: 'Обзор ипотечных программ для ИЖС: ставки, первоначальный взнос, требования к заёмщику и участку.',
    categories: ['mortgage'],
    publishedAt: '2025-12-28',
    readTime: 15
  },
  {
    _id: '5',
    slug: { current: 'ai-v-proektirovanii' },
    title: 'Как AI меняет проектирование домов',
    excerpt: 'Обзор AI-инструментов в архитектуре: генерация планировок, рендеринг, автоматизация документации.',
    categories: ['ai'],
    publishedAt: '2025-12-20',
    readTime: 7
  },
  {
    _id: '6',
    slug: { current: 'energoeffektivnyj-dom' },
    title: 'Энергоэффективный дом: от проекта до реализации',
    excerpt: 'Как спроектировать и построить дом с минимальными затратами на отопление. Утепление, окна, вентиляция.',
    categories: ['construction'],
    publishedAt: '2025-12-15',
    readTime: 14
  }
] as BlogPost[]

// Fetch from Sanity or use fallback
const sanityPosts = await getBlogPosts()
const posts = sanityPosts.length > 0 ? sanityPosts : fallbackPosts
const usingSanity = isSanityConfigured() && sanityPosts.length > 0

// Category mapping
const categoryLabels: Record<string, string> = {
  design: 'Проектирование',
  construction: 'Строительство',
  docs: 'Документы',
  mortgage: 'Ипотека',
  ai: 'Технологии',
  news: 'Новости'
}

const categories = ['Все', 'Проектирование', 'Строительство', 'Документы', 'Ипотека', 'Технологии']

function formatDate(dateStr: string): string {
  const date = new Date(dateStr)
  return date.toLocaleDateString('ru-RU', { year: 'numeric', month: 'long', day: 'numeric' })
}

function getCategoryLabel(categories?: string[]): string {
  if (!categories || categories.length === 0) return 'Статья'
  const cat = categories[0]
  return categoryLabels[cat] || cat
}
---

<Layout
  title="Блог Планометрики — статьи о строительстве дома"
  description="Полезные статьи о проектировании и строительстве домов. Гайды, советы экспертов, обзоры материалов и технологий."
  keywords="блог о строительстве, статьи о проектировании дома, советы по строительству, материалы для дома"
  ogImage="/images/og-blog.jpg"
  canonical="/blog"
>
  <main>
    <!-- Hero -->
    <section class="pt-32 pb-16 bg-gradient-to-b from-gray-50 to-white">
      <div class="container mx-auto px-4">
        <div class="text-center max-w-3xl mx-auto">
          <span class="inline-block px-4 py-2 bg-[#0A4C76]/10 text-[#0A4C76] font-medium rounded-full text-sm mb-4">
            Блог
          </span>
          <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold text-gray-900 mb-6">
            Полезные статьи о строительстве дома
          </h1>
          <p class="text-xl text-gray-600">
            Гайды, советы экспертов, обзоры технологий — всё для тех, кто планирует строить свой дом
          </p>
          {!usingSanity && (
            <p class="text-sm text-gray-400 mt-4">
              Показаны демо-данные. Подключите Sanity для управления контентом.
            </p>
          )}
        </div>
      </div>
    </section>

    <!-- Categories -->
    <section class="py-8 border-b border-gray-100 bg-white sticky top-16 z-30">
      <div class="container mx-auto px-4">
        <div class="flex flex-wrap justify-center gap-3">
          {categories.map((category, index) => (
            <button
              class:list={[
                "px-5 py-2 rounded-full text-sm font-medium transition-colors",
                index === 0
                  ? "bg-[#0A4C76] text-white"
                  : "bg-gray-100 text-gray-700 hover:bg-gray-200"
              ]}
              data-category={category}
            >
              {category}
            </button>
          ))}
        </div>
      </div>
    </section>

    <!-- Posts Grid -->
    <section class="py-16 bg-white">
      <div class="container mx-auto px-4">
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-6xl mx-auto">
          {posts.map((post) => (
            <article class="group" data-categories={JSON.stringify(post.categories)}>
              <a href={`/blog/${post.slug.current}`} class="block">
                <!-- Image -->
                <div class="aspect-video bg-gradient-to-br from-gray-100 to-gray-200 rounded-2xl mb-4 overflow-hidden">
                  {post.mainImage ? (
                    <img
                      src={urlFor(post.mainImage).width(600).height(340).url()}
                      alt={post.mainImage.alt || post.title}
                      class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                    />
                  ) : (
                    <div class="w-full h-full flex items-center justify-center text-gray-400 text-sm group-hover:scale-105 transition-transform duration-300 bg-gradient-to-br from-[#0A4C76]/10 to-[#1A7BB3]/10">
                      <svg class="w-12 h-12 text-[#0A4C76]/30" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                      </svg>
                    </div>
                  )}
                </div>

                <!-- Category & Date -->
                <div class="flex items-center gap-3 mb-3">
                  <span class="px-3 py-1 bg-[#92CF93]/20 text-[#1A7BB3] text-xs font-medium rounded-full">
                    {getCategoryLabel(post.categories)}
                  </span>
                  <span class="text-gray-400 text-sm">{formatDate(post.publishedAt)}</span>
                  {post.readTime && (
                    <span class="text-gray-400 text-sm">· {post.readTime} мин</span>
                  )}
                </div>

                <!-- Title -->
                <h2 class="text-xl font-semibold text-gray-900 mb-2 group-hover:text-[#0A4C76] transition-colors">
                  {post.title}
                </h2>

                <!-- Excerpt -->
                <p class="text-gray-600 line-clamp-2">
                  {post.excerpt}
                </p>
              </a>
            </article>
          ))}
        </div>

        <!-- Load More -->
        <div class="text-center mt-12">
          <button class="px-8 py-3 border-2 border-[#0A4C76] text-[#0A4C76] font-semibold rounded-xl hover:bg-[#0A4C76] hover:text-white transition-colors">
            Загрузить ещё
          </button>
        </div>
      </div>
    </section>

    <!-- Newsletter -->
    <section class="py-24 bg-gray-50">
      <div class="container mx-auto px-4">
        <div class="max-w-2xl mx-auto text-center">
          <div class="w-16 h-16 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-[#0A4C76] to-[#1A7BB3] flex items-center justify-center">
            <svg class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
            </svg>
          </div>
          <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
            Подпишитесь на рассылку
          </h2>
          <p class="text-xl text-gray-600 mb-8">
            Новые статьи, советы экспертов и обновления продуктов — раз в неделю
          </p>
          <form class="flex flex-col sm:flex-row gap-4 max-w-md mx-auto">
            <input
              type="email"
              placeholder="Ваш email"
              class="flex-1 px-5 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#0A4C76]/20 focus:border-[#0A4C76]"
            />
            <button
              type="submit"
              class="px-6 py-3 bg-[#0A4C76] text-white font-semibold rounded-xl hover:bg-[#083d5f] transition-colors"
            >
              Подписаться
            </button>
          </form>
          <p class="text-sm text-gray-500 mt-4">
            Отписаться можно в любой момент. Мы не спамим.
          </p>
        </div>
      </div>
    </section>
  </main>
</Layout>
