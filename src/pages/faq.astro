---
import Layout from '../layouts/Layout.astro'
import { getFAQByCategories, isSanityConfigured } from '../lib/sanity'
import type { FAQCategory } from '../lib/sanity'

// Fallback FAQ data for development / when Sanity is not configured
const fallbackCategories: FAQCategory[] = [
  {
    name: 'Общие вопросы',
    items: [
      {
        _id: '1',
        _createdAt: '',
        question: 'Что такое Планометрика?',
        answer: 'Планометрика — это платформа для проектирования индивидуальных жилых домов. Мы объединяем AI-инструменты для генерации планировок, профессиональный CAD-редактор, визуализацию и автоматическую генерацию документации.',
        category: 'general'
      },
      {
        _id: '2',
        _createdAt: '',
        question: 'Для кого подходит Планометрика?',
        answer: 'Платформа подходит для всех участников рынка ИЖС: частных застройщиков, архитекторов, строительных компаний, риелторов. У нас есть инструменты как для тех, кто впервые строит дом, так и для профессионалов.',
        category: 'general'
      },
      {
        _id: '3',
        _createdAt: '',
        question: 'Можно ли использовать бесплатно?',
        answer: 'Да, базовый функционал доступен бесплатно: генерация планировок, работа в CAD-редакторе, экспорт в PDF. Расширенные возможности (AI-рендер, экспорт в DXF/DWG, командная работа) доступны по подписке.',
        category: 'general'
      }
    ]
  },
  {
    name: 'Студия',
    items: [
      {
        _id: '4',
        _createdAt: '',
        question: 'Что входит в Студия?',
        answer: 'Studio — это полный цикл проектирования: от выбора участка до готовой документации. Включает НейроПлан (AI-генерация), ПланоCAD (редактирование), AI-Рендер (визуализация), модуль документов (СПОЗУ, проектный пакет) и калькулятор ипотеки.',
        category: 'studio'
      },
      {
        _id: '5',
        _createdAt: '',
        question: 'Как работает AI-генерация планировок?',
        answer: 'Вы описываете требования текстом («двухэтажный дом 150 м², 3 спальни, гараж») или загружаете эскиз. AI анализирует запрос и генерирует несколько вариантов планировки с учётом строительных норм (СНиП, инсоляция, пожарные требования).',
        category: 'studio'
      },
      {
        _id: '6',
        _createdAt: '',
        question: 'Сколько вариантов планировки генерируется?',
        answer: 'Обычно AI создаёт 3-5 вариантов с разной компоновкой. Вы можете выбрать лучший или попросить доработать понравившийся вариант.',
        category: 'studio'
      }
    ]
  },
  {
    name: 'ПланоCAD',
    items: [
      {
        _id: '7',
        _createdAt: '',
        question: 'Чем ПланоCAD отличается от AutoCAD?',
        answer: 'ПланоCAD — это специализированный CAD-редактор для планировок домов, который работает в браузере. Не требует установки, имеет интуитивный интерфейс и встроенную библиотеку элементов (двери, окна, мебель, сантехника).',
        category: 'planocad'
      },
      {
        _id: '8',
        _createdAt: '',
        question: 'Можно ли экспортировать в DXF/DWG?',
        answer: 'Да, экспорт в DXF и DWG доступен в тарифе Стандарт и в ПланоCAD. Также доступен экспорт в PDF, PNG, SVG.',
        category: 'planocad'
      },
      {
        _id: '9',
        _createdAt: '',
        question: 'Работает ли ПланоCAD на планшете?',
        answer: 'Да, ПланоCAD полностью адаптирован для работы на планшетах. Поддерживается touch-управление и стилус.',
        category: 'planocad'
      }
    ]
  },
  {
    name: 'AI-Рендер',
    items: [
      {
        _id: '10',
        _createdAt: '',
        question: 'Как быстро создаётся рендер?',
        answer: 'AI-рендер создаёт фотореалистичную визуализацию за 10-30 секунд. Это в сотни раз быстрее традиционного рендеринга.',
        category: 'render'
      },
      {
        _id: '11',
        _createdAt: '',
        question: 'Какое качество изображений?',
        answer: 'AI генерирует изображения в разрешении до 4K. Качество достаточно для презентаций, маркетинговых материалов и согласования с заказчиком.',
        category: 'render'
      },
      {
        _id: '12',
        _createdAt: '',
        question: 'Можно ли выбрать стиль интерьера?',
        answer: 'Да, доступна библиотека стилей: современный, скандинавский, классический, лофт, хай-тек, прованс и другие. Также можно настроить время суток (день, закат, ночь).',
        category: 'render'
      }
    ]
  },
  {
    name: 'Документы и СПОЗУ',
    items: [
      {
        _id: '13',
        _createdAt: '',
        question: 'Что такое СПОЗУ и зачем она нужна?',
        answer: 'СПОЗУ (Схема планировочной организации земельного участка) — обязательный документ для уведомления о начале строительства ИЖС. На ней показывается расположение дома на участке с учётом отступов и зон.',
        category: 'docs'
      },
      {
        _id: '14',
        _createdAt: '',
        question: 'Соответствуют ли документы нормам?',
        answer: 'Да, все документы генерируются с учётом актуальных СНиП, Градостроительного кодекса и местных нормативов. AI проверяет соответствие при создании.',
        category: 'docs'
      },
      {
        _id: '15',
        _createdAt: '',
        question: 'В каком формате предоставляются документы?',
        answer: 'Документы доступны в PDF для печати и согласования, а также в редактируемых форматах (DWG, DXF) для доработки в специализированных программах.',
        category: 'docs'
      }
    ]
  },
  {
    name: 'Оплата и тарифы',
    items: [
      {
        _id: '16',
        _createdAt: '',
        question: 'Какие есть тарифы?',
        answer: 'Два основных тарифа для частных заказчиков: Базовый (бесплатно) — 1 проект, AI-генерация, экспорт PDF. Стандарт (14 900 ₽/проект) — безлимит проектов, AI-рендер, 3D, полный пакет документации. Для профессионалов — тарифы ПланоCAD от 14 900 ₽/мес.',
        category: 'pricing'
      },
      {
        _id: '17',
        _createdAt: '',
        question: 'Есть ли пробный период?',
        answer: 'Да, для тарифа Профи доступен 14-дневный пробный период. Регистрация без карты.',
        category: 'pricing'
      },
      {
        _id: '18',
        _createdAt: '',
        question: 'Как оплатить?',
        answer: 'Принимаем оплату картами Visa, MasterCard, МИР. Для юрлиц доступна оплата по счёту.',
        category: 'pricing'
      }
    ]
  }
]

// Fetch from Sanity or use fallback
const sanityCategories = await getFAQByCategories()
const faqCategories = sanityCategories.length > 0 ? sanityCategories : fallbackCategories
const usingSanity = isSanityConfigured() && sanityCategories.length > 0

const faqSchema = {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: faqCategories.flatMap((cat) =>
    cat.items.map((item) => ({
      '@type': 'Question',
      name: item.question,
      acceptedAnswer: {
        '@type': 'Answer',
        text: item.answer,
      },
    }))
  ),
}
---

<Layout
  title="FAQ — Вопросы и ответы о Планометрике"
  description="Ответы на частые вопросы о проектировании домов в Планометрике: тарифы, AI-инструменты, документы, СПОЗУ."
  keywords="вопросы о проектировании дома, FAQ Планометрика, помощь проектирование, как создать проект дома"
  ogImage="/images/og-faq.jpg"
  canonical="/faq"
  schema={faqSchema}
>
  <main>
    <!-- Hero -->
    <section class="pt-32 pb-16 bg-gradient-to-b from-gray-50 to-white">
      <div class="container mx-auto px-4">
        <div class="text-center max-w-3xl mx-auto">
          <span class="inline-block px-4 py-2 bg-[#92CF93]/20 text-[#1A7BB3] font-medium rounded-full text-sm mb-4">
            Поддержка
          </span>
          <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold text-gray-900 mb-6">
            Вопросы и ответы
          </h1>
          <p class="text-xl text-gray-600">
            Ответы на популярные вопросы о платформе, функционале и тарифах
          </p>
          {!usingSanity && (
            <p class="text-sm text-gray-400 mt-4">
              Показаны демо-данные. Подключите Sanity для управления контентом.
            </p>
          )}
        </div>
      </div>
    </section>

    <!-- Search -->
    <section class="py-8 bg-white border-b border-gray-100">
      <div class="container mx-auto px-4">
        <div class="max-w-2xl mx-auto">
          <div class="relative">
            <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <input
              type="text"
              id="faq-search"
              placeholder="Поиск по вопросам..."
              class="w-full pl-12 pr-4 py-4 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#0A4C76]/20 focus:border-[#0A4C76]"
            />
          </div>
        </div>
      </div>
    </section>

    <!-- FAQ Sections -->
    <section class="py-16 bg-white">
      <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto" id="faq-container">
          {faqCategories.map((category, categoryIndex) => (
            <div class="mb-12 faq-category" data-category={category.name}>
              <h2 class="text-2xl font-bold text-gray-900 mb-6 pb-3 border-b border-gray-200">
                {category.name}
              </h2>

              <div class="space-y-4">
                {category.items.map((item, index) => (
                  <details
                    class="group bg-gray-50 rounded-xl faq-item"
                    data-question={item.question.toLowerCase()}
                    data-answer={item.answer.toLowerCase()}
                    open={categoryIndex === 0 && index === 0}
                  >
                    <summary class="flex items-center justify-between cursor-pointer p-6 list-none">
                      <h3 class="text-lg font-medium text-gray-900 pr-8">
                        {item.question}
                      </h3>
                      <span class="flex-shrink-0 w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center group-open:rotate-180 transition-transform">
                        <svg class="w-4 h-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                        </svg>
                      </span>
                    </summary>
                    <div class="px-6 pb-6 pt-0">
                      <p class="text-gray-600 leading-relaxed">
                        {item.answer}
                      </p>
                    </div>
                  </details>
                ))}
              </div>
            </div>
          ))}
        </div>
      </div>
    </section>

    <!-- Still Have Questions -->
    <section class="py-24 bg-gradient-to-br from-[#0A4C76] to-[#1A7BB3]">
      <div class="container mx-auto px-4">
        <div class="max-w-3xl mx-auto text-center text-white">
          <h2 class="text-3xl md:text-4xl font-bold mb-4">
            Не нашли ответ?
          </h2>
          <p class="text-xl text-white/80 mb-8">
            Напишите нам — ответим в течение рабочего дня
          </p>

          <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <a
              href="mailto:hello@planometrica.pro"
              class="inline-flex items-center justify-center gap-2 px-8 py-4 bg-white text-[#0A4C76] font-semibold rounded-xl hover:bg-gray-100 transition-colors"
            >
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
              hello@planometrica.pro
            </a>
            <a
              href="https://t.me/planometrica"
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center justify-center gap-2 px-8 py-4 bg-white/10 text-white font-semibold rounded-xl hover:bg-white/20 transition-colors border border-white/20"
            >
              <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
              </svg>
              Telegram
            </a>
          </div>
        </div>
      </div>
    </section>

    <!-- Related Resources -->
    <section class="py-16 bg-gray-50">
      <div class="container mx-auto px-4">
        <div class="text-center mb-12">
          <h2 class="text-2xl md:text-3xl font-bold text-gray-900">
            Полезные ресурсы
          </h2>
        </div>

        <div class="grid md:grid-cols-3 gap-6 max-w-4xl mx-auto">
          <a href="/blog" class="group bg-white rounded-2xl p-6 border border-gray-100 hover:shadow-lg transition-shadow">
            <div class="w-12 h-12 mb-4 rounded-xl bg-[#0A4C76]/10 flex items-center justify-center">
              <svg class="w-6 h-6 text-[#0A4C76]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
              </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2 group-hover:text-[#0A4C76] transition-colors">
              Блог
            </h3>
            <p class="text-gray-600 text-sm">
              Статьи о проектировании и строительстве домов
            </p>
          </a>

          <a href="https://studio.planometrica.ru/docs" target="_blank" rel="noopener noreferrer" class="group bg-white rounded-2xl p-6 border border-gray-100 hover:shadow-lg transition-shadow">
            <div class="w-12 h-12 mb-4 rounded-xl bg-[#1A7BB3]/10 flex items-center justify-center">
              <svg class="w-6 h-6 text-[#1A7BB3]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25z" />
              </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2 group-hover:text-[#1A7BB3] transition-colors">
              Документация
            </h3>
            <p class="text-gray-600 text-sm">
              Руководства и инструкции по работе с платформой
            </p>
          </a>

          <a href="https://www.youtube.com/@planometrica" target="_blank" rel="noopener noreferrer" class="group bg-white rounded-2xl p-6 border border-gray-100 hover:shadow-lg transition-shadow">
            <div class="w-12 h-12 mb-4 rounded-xl bg-[#92CF93]/20 flex items-center justify-center">
              <svg class="w-6 h-6 text-[#1A7BB3]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" d="M15.75 10.5l4.72-4.72a.75.75 0 011.28.53v11.38a.75.75 0 01-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25h-9A2.25 2.25 0 002.25 7.5v9a2.25 2.25 0 002.25 2.25z" />
              </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2 group-hover:text-[#1A7BB3] transition-colors">
              Видеоуроки
            </h3>
            <p class="text-gray-600 text-sm">
              Обучающие видео на YouTube канале
            </p>
          </a>
        </div>
      </div>
    </section>
  </main>
</Layout>

<script>
  // Simple FAQ search functionality
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('faq-search') as HTMLInputElement
    const faqItems = document.querySelectorAll('.faq-item')
    const faqCategories = document.querySelectorAll('.faq-category')

    if (!searchInput) return

    searchInput.addEventListener('input', () => {
      const query = searchInput.value.toLowerCase().trim()

      if (!query) {
        // Show all items
        faqItems.forEach(item => {
          (item as HTMLElement).style.display = ''
        })
        faqCategories.forEach(cat => {
          (cat as HTMLElement).style.display = ''
        })
        return
      }

      // Filter items
      faqCategories.forEach(category => {
        const items = category.querySelectorAll('.faq-item')
        let hasVisibleItems = false

        items.forEach(item => {
          const question = item.getAttribute('data-question') || ''
          const answer = item.getAttribute('data-answer') || ''
          const matches = question.includes(query) || answer.includes(query)

          ;(item as HTMLElement).style.display = matches ? '' : 'none'
          if (matches) {
            hasVisibleItems = true
            ;(item as HTMLDetailsElement).open = true
          }
        })

        ;(category as HTMLElement).style.display = hasVisibleItems ? '' : 'none'
      })
    })
  })
</script>
